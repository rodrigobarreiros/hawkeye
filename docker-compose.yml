services:
  # Web Dashboard
  web:
    image: nginx:alpine
    container_name: cerberus-web
    ports:
      - "8080:80"
    volumes:
      - ./server/web:/usr/share/nginx/html:ro
    networks:
      - cerberus-net
    restart: unless-stopped

  # Pipeline 1: File → RTSP
  pipeline-rtsp:
    build:
      context: ./pipeline-rtsp
      dockerfile: Dockerfile
    container_name: cerberus-pipeline-rtsp
    ports:
      - "8554:8554"
      - "9001:9001"  # Metrics/health endpoint
    environment:
      - VIDEO_PATH=/app/resources/camera2_fixed.mp4
    networks:
      - cerberus-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9001/livez || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Pipeline 3: MediaMTX Server (SRT/WebRTC/HLS)
  # Started before Pipeline 2 so SRT endpoint is available
  mediamtx:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: cerberus-mediamtx
    ports:
      # RTSP (optional re-streaming)
      - "8555:8555"
      # HLS (browser playback)
      - "8888:8888"
      # WebRTC HTTP
      - "8889:8889"
      # WebRTC UDP/TCP
      - "8189:8189/udp"
      - "8189:8189/tcp"
      # SRT (Pipeline 2 publishes here, VLC can read)
      - "9000:9000/udp"
      # API
      - "9997:9997"
      # Metrics (Prometheus)
      - "9998:9998"
    volumes:
      - ./server/mediamtx.yml:/mediamtx.yml:ro
      - ./server/web:/web:ro
    networks:
      - cerberus-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/mediamtx", "--help"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s

  # Pipeline 2: RTSP → SRT
  pipeline-rtsp-to-srt:
    build:
      context: ./pipeline-rtsp-to-srt
      dockerfile: Dockerfile
    container_name: cerberus-pipeline-rtsp-to-srt
    ports:
      - "9002:9002"  # Metrics/health endpoint
    environment:
      - RTSP_URL=rtsp://pipeline-rtsp:8554/cam1
      - SRT_URL=srt://mediamtx:9000?mode=caller&streamid=publish:cam1&latency=200
      - METRICS_PORT=9002
      - RUST_LOG=info
    depends_on:
      pipeline-rtsp:
        condition: service_healthy
      mediamtx:
        condition: service_healthy
    networks:
      - cerberus-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9002/livez || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

networks:
  cerberus-net:
    driver: bridge
