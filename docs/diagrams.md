Diagrams

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    HAWKEYE VIDEO PIPELINE                               │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                  DOCKER COMPOSE                                         │
│                                                                                         │
│  Network: hawkeye-net (bridge)                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                                                                    │ │
│  │  ┌─────────────────────┐                                                           │ │
│  │  │ hawkeye-web         │                                                           │ │
│  │  │ (nginx:alpine)      │──────────────────────────────────────────► :8080          │ │
│  │  │                     │                                             Dashboard     │ │
│  │  │ volumes:            │                                                           │ │
│  │  │  - server/web       │                                                           │ │
│  │  └─────────────────────┘                                                           │ │
│  │                                                                                    │ │
│  │  ┌─────────────────────┐                                                           │ │
│  │  │ hawkeye-pipeline-   │                                                           │ │
│  │  │ rtsp                │──────────────────────────────────────────► :8554 RTSP     │ │
│  │  │                     │──────────────────────────────────────────► :9001 metrics  │ │
│  │  │ build: pipeline-rtsp│                                                           │ │
│  │  │                     │                                                           │ │
│  │  │ healthcheck:        │                                                           │ │
│  │  │  curl /livez        │                                                           │ │
│  │  └──────────┬──────────┘                                                           │ │
│  │             │                                                                      │ │
│  │             │ rtsp://pipeline-rtsp:8554/cam1                                       │ │
│  │             │                                                                      │ │
│  │             ▼                                                                      │ │
│  │  ┌─────────────────────┐         ┌─────────────────────┐                           │ │
│  │  │ hawkeye-pipeline-   │         │ hawkeye-mediamtx    │                           │ │
│  │  │ rtsp-to-srt         │         │                     │──────► :8555 RTSP         │ │
│  │  │                     │         │ build: server/      │──────► :8888 HLS          │ │
│  │  │ build: pipeline-    │         │                     │──────► :8889 WebRTC       │ │
│  │  │   rtsp-to-srt       │         │ volumes:            │──────► :9000 SRT          │ │
│  │  │                     │         │  - mediamtx.yml     │──────► :9997 API          │ │
│  │  │ depends_on:         │         │  - web/             │──────► :9998 metrics      │ │
│  │  │  - pipeline-rtsp    │         │                     │                           │ │
│  │  │    (healthy)        │         │ healthcheck:        │                           │ │
│  │  │  - mediamtx         │         │  mediamtx --help    │                           │ │
│  │  │    (healthy)        │         │                     │                           │ │
│  │  │                     │         └──────────▲──────────┘                           │ │
│  │  │ healthcheck:        │                    │                                      │ │
│  │  │  curl /livez        │                    │                                      │ │
│  │  └──────────┬──────────┘                    │                                      │ │
│  │             │                               │                                      │ │
│  │             │ srt://mediamtx:9000           │                                      │ │
│  │             └───────────────────────────────┘                                      │ │
│  │                                                                                    │ │
│  │  :9002 metrics ◄──────────────────────────────                                     │ │
│  │                                                                                    │ │
│  └────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│  Startup Order:                                                                         │
│  1. hawkeye-web         (no dependencies)                                               │
│  2. hawkeye-pipeline-rtsp    (no dependencies)                                          │
│  3. hawkeye-mediamtx         (no dependencies)                                          │
│  4. hawkeye-pipeline-rtsp-to-srt (waits for pipeline-rtsp AND mediamtx healthy)         │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    DATA FLOW                                            │
│                                                                                         │
│                                    ┌──────────────┐                                     │
│                                    │  camera.mp4  │                                     │
│                                    └──────┬───────┘                                     │
│                                           │                                             │
│                                           ▼                                             │
│  ┌────────────────────────────────────────────────────────────────────────────────┐     │
│  │                     hawkeye-pipeline-rtsp (Pipeline 1)                         │     │
│  │                                                                                │     │
│  │   filesrc ──► qtdemux ──► h264parse ──► rtph264pay ──► RTSP Server             │     │
│  └────────────────────────────────────────────────────────────────────────────────┘     │
│                                           │                                             │
│                                           │ RTSP                                        │
│                                           ▼                                             │
│  ┌────────────────────────────────────────────────────────────────────────────────┐     │
│  │                  hawkeye-pipeline-rtsp-to-srt (Pipeline 2)                     │     │
│  │                                                                                │     │
│  │   rtspsrc ──► rtph264depay ──► h264parse ──► mpegtsmux ──► srtsink             │     │
│  └────────────────────────────────────────────────────────────────────────────────┘     │
│                                           │                                             │
│                                           │ SRT                                         │
│                                           ▼                                             │
│  ┌────────────────────────────────────────────────────────────────────────────────┐     │
│  │                        hawkeye-mediamtx (Pipeline 3)                           │     │
│  │                                                                                │     │
│  │                            ┌─────────────────┐                                 │     │
│  │                            │    MediaMTX     │                                 │     │
│  │                            └────────┬────────┘                                 │     │
│  │                                     │                                          │     │
│  │              ┌──────────────────────┼──────────────────────┐                   │     │
│  │              ▼                      ▼                      ▼                   │     │
│  │        ┌──────────┐          ┌──────────┐          ┌──────────┐                │     │
│  │        │  WebRTC  │          │   HLS    │          │   RTSP   │                │     │
│  │        │  :8889   │          │  :8888   │          │  :8555   │                │     │
│  │        │  ~200ms  │          │   ~8s    │          │   ~1s    │                │     │
│  │        └────┬─────┘          └────┬─────┘          └────┬─────┘                │     │
│  │             │                     │                     │                      │     │
│  └─────────────┼─────────────────────┼─────────────────────┼──────────────────────┘     │
│                │                     │                     │                            │
│                ▼                     ▼                     ▼                            │
│          ┌──────────┐          ┌──────────┐          ┌──────────┐                       │
│          │ Browser  │          │  Mobile  │          │   VLC    │                       │
│          └──────────┘          └──────────┘          └──────────┘                       │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                  CLEAN ARCHITECTURE                                     │
│                            (Pipeline 1 & 2 internal structure)                          │
│                                                                                         │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              main.rs (Composition Root)                           │  │
│  │                                                                                   │  │
│  │   Creates and wires: GStreamerBridge + PrometheusReporter → BridgeService         │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                          │                                              │
│                                          ▼                                              │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                           Application Layer (services/)                           │  │
│  │                                                                                   │  │
│  │   BridgeService, StreamingService - orchestrate use cases                         │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                          │                                              │
│                                          ▼                                              │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                             Domain Layer (domain/)                                │  │
│  │                                                                                   │  │
│  │   Entities: ConnectionLifecycle, StreamSession                                    │  │
│  │   Value Objects: ConnectionState, BackoffPolicy, BridgeConfig                     │  │
│  │   Ports (traits): StreamBridge, StreamingServer, MetricsReporter                  │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                          ▲                                              │
│                                          │ implements                                   │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                        Infrastructure Layer (infrastructure/)                     │  │
│  │                                                                                   │  │
│  │   Adapters: GStreamerBridge, GStreamerRtspServer, PrometheusReporter              │  │
│  │   Servers: Warp HTTP (metrics, health)                                            │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    OBSERVABILITY                                        │
│                                                                                         │
│     ┌───────────────────┐    ┌───────────────────┐    ┌───────────────────┐             │
│     │ hawkeye-pipeline- │    │ hawkeye-pipeline- │    │ hawkeye-mediamtx  │             │
│     │ rtsp              │    │ rtsp-to-srt       │    │                   │             │
│     │ :9001             │    │ :9002             │    │ :9998             │             │
│     │                   │    │                   │    │                   │             │
│     │ /metrics          │    │ /metrics          │    │ /metrics          │             │
│     │ /health           │    │ /health           │    │                   │             │
│     │ /livez            │    │ /livez            │    │                   │             │
│     │ /readyz           │    │ /readyz           │    │                   │             │
│     └───────────────────┘    └───────────────────┘    └───────────────────┘             │
│                                                                                         │
│     Prometheus-compatible metrics exposed via HTTP (Warp server)                        │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                 RESILIENCE MECHANISMS                                   │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                           Exponential Backoff                                   │   │
│   │                                                                                 │   │
│   │   Attempt:    1      2      3      4       5       6+                           │   │
│   │   Delay:     1s     2s     4s     8s     16s     30s (max)                      │   │
│   │              │      │      │      │       │       │                             │   │
│   │              ▼      ▼      ▼      ▼       ▼       ▼                             │   │
│   │   ──────────[X]────[X]────[X]────[X]─────[X]─────[✓]────────────────►           │   │
│   │            fail   fail   fail   fail    fail   success                          │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                         Independent Failure Domains                             │   │
│   │                                                                                 │   │
│   │   Pipeline 1 crash ──► Pipeline 2 reconnects with backoff                       │   │
│   │   Pipeline 2 crash ──► Pipeline 1 & 3 unaffected                                │   │
│   │   Pipeline 3 crash ──► Pipeline 1 & 2 unaffected                                │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                         Docker Health Checks                                    │   │
│   │                                                                                 │   │
│   │   hawkeye-pipeline-rtsp:        curl -sf http://localhost:9001/livez            │   │
│   │   hawkeye-pipeline-rtsp-to-srt: curl -sf http://localhost:9002/livez            │   │
│   │   hawkeye-mediamtx:             /mediamtx --help                                │   │
│   │                                                                                 │   │
│   │   restart: unless-stopped (all containers)                                      │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │                              SRT Buffer                                         │   │
│   │                                                                                 │   │
│   │   Handles jitter and short outages (1-5 seconds)                                │   │
│   │   Configured via latency parameter (currently 200ms)                            │   │
│   │                                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    PORT SUMMARY                                         │
│                                                                                         │
│   External Ports:                                                                       │
│   ┌─────────┬─────────────────────┬─────────────────────────────────────────────────┐   │
│   │  Port   │  Service            │  Purpose                                        │   │
│   ├─────────┼─────────────────────┼─────────────────────────────────────────────────┤   │
│   │  8080   │  hawkeye-web        │  Dashboard (nginx)                              │   │
│   │  8554   │  pipeline-rtsp      │  RTSP source stream                             │   │
│   │  8555   │  mediamtx           │  RTSP re-stream                                 │   │
│   │  8888   │  mediamtx           │  HLS playback                                   │   │
│   │  8889   │  mediamtx           │  WebRTC playback                                │   │
│   │  9000   │  mediamtx           │  SRT input/output                               │   │
│   │  9001   │  pipeline-rtsp      │  Metrics & health                               │   │
│   │  9002   │  pipeline-rtsp-srt  │  Metrics & health                               │   │
│   │  9997   │  mediamtx           │  API                                            │   │
│   │  9998   │  mediamtx           │  Metrics                                        │   │
│   └─────────┴─────────────────────┴─────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
